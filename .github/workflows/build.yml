# SPDX-FileCopyrightText: Â© Vegard IT GmbH (https://vegardit.com) and contributors
# SPDX-FileContributor: Sebastian Thomschke, Vegard IT GmbH
# SPDX-License-Identifier: Apache-2.0
# SPDX-ArtifactOfProjectHomePage: https://github.com/vegardit/scoop-portable
#
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax
name: Build

on:  # https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows
  schedule:
    # https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows#schedule
    - cron: "0 15 1 * *"
  push:
    branches-ignore:  # build all branches except:
    - "dependabot/**"  # prevent GHA triggered twice (once for commit to the branch and once for opening/syncing the PR)
    tags-ignore:  # don't build tags
    - "**"
    paths-ignore:
    - ".act*"
    - "**/*.adoc"
    - "**/*.md"
    - ".editorconfig"
    - ".git*"
    - ".github/*.yml"
    - ".github/ISSUE_TEMPLATE/*"
    - ".github/workflows/stale.yml"
  pull_request:
    paths-ignore:
    - ".act*"
    - "**/*.adoc"
    - "**/*.md"
    - ".editorconfig"
    - ".git*"
    - ".github/*.yml"
    - ".github/ISSUE_TEMPLATE/*"
    - ".github/workflows/stale.yml"
  workflow_dispatch:
    # https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows#workflow_dispatch


defaults:
  run:
    shell: cmd


jobs:
  ###########################################################
  build:
  ###########################################################
    runs-on: windows-latest

    steps:
    - name: Git Checkout
      uses: actions/checkout@v6  # https://github.com/actions/checkout


    - name: Create Windows user 'noadmin'
      run: |
        net user noadmin p@ssw0rd /add


    - name: Install sudo
      run: |
       curl -sSfL https://github.com/chrisant996/sudo-windows/releases/download/v1.0.3/sudo-x64-v1.0.3.c01d18-exe.zip -o sudo.zip
       unzip sudo.zip -d C:\Windows\System32

    # https://github.com/poweradminllc/PAExec
    #- name: Install paexec
    #  run: curl -sSfL https://www.poweradmin.com/paexec/paexec.exe -o C:\Windows\System32\paexec.exe


    - name: "Install: scoop-portable"
      # installs scoop-portable as user "nonadmin"
      run: |
        cd tests
        copy ..\scoop-portable.cmd .

        :: paexec could be used as alternative to chris' sudo:
        ::   paexec -u noadmin -p p@ssw0rd -w %CD% cmd /c scoop-portable.cmd ^>log.txt
        ::   cat log.txt

        echo p@ssw0rd| sudo -u noadmin --stdin cmd /c scoop-portable.cmd


    - name: "Test: scoop-portable"
      run: echo p@ssw0rd| sudo -u noadmin --stdin cmd /c "%CD%\tests\test-scoop.cmd"


    - name: "Test: scoop-portable - different user and path"
      # moves scoop-portable installation path and runs scoop-portable under different user
      run: |
        :: move scoop portable folder to another location
        ren tests my_new_scoop_dir

        :: load environment as different user (i.e. "runner")
        my_new_scoop_dir\test-scoop.cmd


    - name: "Test: scoop-portable - scoop update"
      run: my_new_scoop_dir\test-update.cmd
